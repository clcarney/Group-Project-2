---
title: "Loan_Defaults"
author: "ChrisCarney_LisaStimpson_JaeChoi_YiHan_NiklasRikala"
date: "4/7/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
INTRO
  The objective of this analysis is to utilize data sourced from a peer-to-peer lending service to reliably determine when a borrower will default on a loan. In order to achieve this, the data must be examined, subjectivley and objectivley, with an understanding of loans and basic finance to determine which factors will and will not be valuable to predicting loan defults. The data consists of 52 variables regarding information about the borrowers current and past financial, credit, residential, and employment history.First we will examine and clean the data. 

```{r}
loans<-read.csv('Listings2013.csv')
str(loans)
summary(loans)
#Duplicate Information
  #loan_status-desription - Remove status because it hold less information
loans$loan_status<-NULL
  #income_range-description - Remove Range because it holds less information
loans$income_range<-NULL
#Non-sensical Values
  #DTI--- 1000000 --- investigate
dti_invest<-subset(loans,loans$dti_wprosper_loan==1000000)#DTI is set to 1000000 when Income Verifiable is False -- How do we handle this? Subsitute Stated income to calculate this?
  #MonthsEmployed --- negative values?
months_emp_invest<-subset(loans,loans$months_employed<0) #Doesn't make sence how should we handle this? Take absolute value?
loans$months_employed<-abs(loans$months_employed)
summary(loans$months_employed)
  #bankcard Utilization -- Can this value be over 1?
  
#Missing Values
  #Installment Values
installment_invest<-subset(loans,is.na(loans$installment_balance)) #How should we handle? Set to 0 if installments not available?
months_NA_inv<-subset(loans,is.na(loans$months_employed)) #How do we handle these? Occupation is mostly Null Here
loans<-na.omit(loans) #Removed for Now

#Reformatting
#Dates
library(lubridate)
loans$loan_origination_date<-mdy(loans$loan_origination_date)
loans$month<-month(loans$loan_origination_date)
loans$weekday<-factor(weekdays(loans$loan_origination_date))

loans$first_recorded_credit_line<-mdy(loans$first_recorded_credit_line)
loans$credit_age<-as.numeric(loans$loan_origination_date-loans$first_recorded_credit_line)
loans$loan_origination_date<-NULL
loans$first_recorded_credit_line<-NULL
#Factors
loans$listing_category_id<-factor(loans$listing_category_id)
loans$lender_indicator<-factor(loans$lender_indicator)
loans$listing_term<-factor(loans$listing_term)
#Remove Useless Data
loans$borrower_city<-NULL
loans$borrower_state<-NULL
#Create Default variable
loans$default<-ifelse(loans$loan_status_description=='DEFAULTED',1,0)
#Remove "unknown" data at time of interest rate determination, and data that we cannot interpret
loans$number_of_days<-NULL
loans$loan_status_description<-NULL
loans$principal_balance<-NULL
loans$borrower_rate<-NULL
loans$listing_monthly_payment<-NULL
loans$prosper_rating<-NULL
loans$prosper_score<-NULL
loans$listing_category_id<-NULL
#Data Exploration
loansDefualted<-subset(loans,loans$default==1) #Only Defaulted Loans
plot(loansDefualted$scorex) #Largest proportion of defaulted loans comes from Mid Score range, and then high scores posibbly becauase loans arent typically given to people with lower scores 
plot(loans$scorex) #Most loans are only for high credit score borrowers

plot(loansDefualted$income_range_description) #Againt, most defaults come from mid income range, is this because loans not typically given to low income?
plot(loans$income_range_description)#Confirmed, only loans given to higher income borrowers

plot(loansDefualted$employment_status_description) #Highest priority of Defualted Loans comes From Employed or Other
plot(loansDefualted$lender_indicator) #Very Few Lenders default on laons, this will likely be a significant factor
hist(loansDefualted$delinquencies_over90_days) #No significant difference among 30,60,90 days
hist(loansDefualted$bankcard_utilization) #borrowers with higher card utilization make a higher proportion of defaulted laons
hist(loansDefualted$total_inquiries) #People with fewer credit checks make a larger proportion of people who default
hist(loansDefualted$month) #September is a big month to start defaulted loans ... students?
hist(loansDefualted$credit_age) #Approximatley normally distributed with largest proportion around 5000 days of credit












```
DATA CLEANING
  After loading the data set and examining its structure and a summary of each variable some discrepancies were found. There was duplicate varaibles for the loan status and income range values, the versions that contained more complete information were then selected and the other verisons removed. There were non sensical values that needed to be investigated including values of 1000000 in DTI ratios (found to mean income not verifiable or income is 0 and therefore the ratio goes to infinity) and negative Months of employment for people listed as employed (no significant understanding found). Thus far, it has been decided that 1000000 is a reasonable representation of infinity and therefore it will remain (for now). To handle negative months of employment, the absolute value of these numbers was taken to remove thier negative effect (IDK if this is the right approach). Additionally, all data that was deemed "unknown" at time of assigning interest rate were removed. This includes, number of days, borrower rate, and monthly payment. Also removed were scores and rating provided by the loan service that might alter how other, "real" credit measure are interpreted in the model, these included propser rating, prosper score, and listing category ID. The Remaining data was then put into a logistic regression. 

```{r}
#Logistic Regression
library(lmtest)
loans.m1<-glm(formula = default ~ . , data = loans)
summary(loans.m1) #Need to so some removing of conflicting varaibles

full<-glm(formula = default~.,data=loans)
null<-glm(formula = default~1,data = loans)
forwardSteps<-step(null,scope = list(lower = null, upper = full),data = loans, direction = 'both')

loans.m2<-glm(formula = default ~ income_range_description + scorex + total_inquiries + 
    month + listing_term + monthly_debt + weekday + total_open_revolving_accounts + 
    lender_indicator + was_delinquent_derog + inquiries_last6_months + 
    amount_funded,data = loans)
summary(loans.m2)

loans2<-subset(loans,select = c(default, income_range_description , scorex , total_inquiries , 
    month , listing_term , monthly_debt , weekday , total_open_revolving_accounts , 
    lender_indicator , was_delinquent_derog , inquiries_last6_months , amount_funded))
loans2$default<-factor(loans2$default)
```
REGRESSION ANALYSIS
  the initial, full logistic regression resulted in few signifigant predictors, suggesting that certain variables be removed. While we had some knowledge of what financial predictors may be helpful in determining default probability, we determined it would be better to statistically evaluate significane of each predictor and remove variables as needed, then assess the validity of the result. A stepwise regression was then performed in both directions to determine the best predictors to include in the model to reach maximum significance. They included thirteen variables that encompassed properties of many other variables in the data set (i.e. income_range_description includes informaiton from occupation and stated income). This submodel also has the lowest AIC of any combination of variables in the original full model, suggesting it is a better indicator of default probability. Thes varibales were then transfered to a new data frame to be fed into preciditive models.

```{r}
#KNN
library(caret)
library(gmodels)
library(class)
#Check Composition
table(loans2$default) #Defaults are rouglhy 4.5%

loans2<-as.data.frame(model.matrix(~.-1,data=loans2))
loans2$default0<-
set.seed(12345)
loans_rand <- loans2[order(runif(33300)), ]
loans2_train<-loans2[1:23310,]
loans2_test<-loans2[23311:33300,]
loans2_train_labels<-loans2[1:23310,1]
loans2_test_labels<-loans2[23311:33300,1]
table(loans2_test$default1) #Defaults are rouglhy 3.8%
table(loans2_train$default1) #Defaults are rouglhy 4.9%
loans2_knn<-knn(train = loans2_train,test = loans2_test, cl=loans2_train_labels)
CrossTable(x=loans2_test_labels,y=loans2_knn, prop.chisq = F)
confusionMatrix(loans2_knn,loans2_test$default1, positive = '1')
#False Negatives are more costly -- people that we predict will not default but will actually default -- this will lose us money
#Lets Try a Low k
loans2_knn_low<-knn(train = loans2_train,test = loans2_test, cl=loans2_train_labels, k=5)
confusionMatrix(loans2_knn_low,loans2_test$default1, positive = '1')

#Try 


```




